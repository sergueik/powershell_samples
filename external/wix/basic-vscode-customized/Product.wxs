<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <Product Id="*" Name="VSCode Custom Installer" Language="1033" Version="1.0.0.0"
           Manufacturer="MyCompany" UpgradeCode="4f63a60c-8958-4990-9cad-af6357b8da8c">
    
    <!-- Per-user MSI -->
    <Package InstallerVersion="200" Compressed="yes" InstallScope="perUser" />
    <MediaTemplate />

    <!-- Directory structure -->
    <Directory Id="TARGETDIR" Name="SourceDir">
      <!-- VS Code installation -->
      <Directory Id="LocalAppDataFolder">
        <Directory Id="VSCodeInstallDir" Name="Microsoft VS Code">
          <Directory Id="VSCodeBinDir" Name="bin" />
        </Directory>
      </Directory>

      <!-- User configuration -->
      <Directory Id="AppDataFolder">
        <Directory Id="CodeUserDir" Name="Code">
          <Directory Id="CodeConfigDir" Name="User" />
        </Directory>
      </Directory>

      <!-- Temporary staging folder for VSIX -->
      <Directory Id="TempFolder">
        <Directory Id="VSIXFolder" Name="VSIX" />
      </Directory>
    </Directory>

    <!-- VS Code installer component -->
    <DirectoryRef Id="VSCodeInstallDir">
      <Component Id="VSCodeInstallerComponent" Guid="d53785a0-fd10-4c7b-81b6-6c19d1d5361b">
        <RegistryValue Root="HKCU" Key="Software\MyCompany\VSCodeCustom"
                       Name="InstallerKey" Type="string" Value="1" KeyPath="yes" />
        <File Id="VSCodeSetupExe" Source="Files\vscode-installer.exe" />

        <RemoveFolder Id="RemoveVSCodeBinDir" Directory="VSCodeBinDir" On="uninstall" />
        <RemoveFolder Id="RemoveVSCodeInstallDir" Directory="VSCodeInstallDir" On="uninstall" />
      </Component>
    </DirectoryRef>

    <!-- VSIX component with batch wrapper -->
    <DirectoryRef Id="VSIXFolder">
      <Component Id="InstallVSIXComponent" Guid="9c2b2aa2-2a4b-4fa2-b59b-9d1a8a3d1234">
        <File Id="InstallVSIXBat" Source="Files\InstallVSIX.bat" KeyPath="yes" />
        <File Id="MyExtensionVsix" Source="Files\vscode-extension-for-zowe.vsix" />
      </Component>
    </DirectoryRef>

    <!-- User settings component -->
    <DirectoryRef Id="CodeConfigDir">
      <Component Id="CodeConfigComponent" Guid="f485e380-3a0d-4b92-8dd6-e5e24205ff5d">
        <RegistryValue Root="HKCU" Key="Software\MyCompany\VSCodeCustom"
                       Name="CodeConfigDirKey" Type="string" Value="1" KeyPath="yes" />
        <File Id="SettingsJson" Source="Files\settings.json" />
        <File Id="KeybindingsJson" Source="Files\keybindings.json" />
        <RemoveFolder Id="RemoveCodeConfigDir" Directory="CodeConfigDir" On="uninstall" />
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="CodeUserDir">
      <Component Id="CodeUserComponent" Guid="b4c06d83-f7f3-4d5c-a754-d8b054c86d13">
        <RegistryValue Root="HKCU" Key="Software\MyCompany\VSCodeCustom"
                       Name="CodeUserDirKey" Type="string" Value="1" KeyPath="yes" />
        <RemoveFolder Id="RemoveCodeUserDir" Directory="CodeUserDir" On="uninstall" />
      </Component>
    </DirectoryRef>
    <!-- CustomActions -->
    <CustomAction Id="RunVSCodeInstaller"
                  FileKey="VSCodeSetupExe"
                  ExeCommand="/VERYSILENT /NORESTART /MERGETASKS=!runcode /LOG=&quot;[TempFolder]vscode_installer.log&quot;"
                  Execute="deferred"
                  Impersonate="no"
                  Return="check" />

    <CustomAction Id="InstallVSIX"
                  FileKey="InstallVSIXBat"
									ExeCommand='cmd.exe /c "[#InstallVSIXBatFile]"'
                  Execute="deferred"
                  Impersonate="yes"
                  Return="check" />

    <InstallExecuteSequence>
      <Custom Action="RunVSCodeInstaller" After="InstallFiles">NOT Installed</Custom>
      <Custom Action="InstallVSIX" After="RunVSCodeInstaller">NOT Installed</Custom>
    </InstallExecuteSequence>

    <!-- Feature tree -->
    <Feature Id="MainFeature" Title="VSCode Custom Installer" Level="1">
      <ComponentRef Id="VSCodeInstallerComponent" />
      <ComponentRef Id="InstallVSIXComponent" />
      <ComponentRef Id="CodeConfigComponent" />
      <ComponentRef Id="CodeUserComponent" />
    </Feature>

  </Product>
</Wix>
