<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <Product Id="*" Name="VSCode Custom Installer" Language="1033" Version="1.0.0.0"
           Manufacturer="MyCompany" UpgradeCode="4f63a60c-8958-4990-9cad-af6357b8da8c">
    <Package InstallerVersion="200" Compressed="yes" InstallScope="perUser" />
    <MediaTemplate />

    <!-- Directory structure -->
    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="LocalAppDataFolder">
        <!-- Dummy parent Programs folder for ICE64 -->
        <Directory Id="LocalAppDataPrograms" Name="Programs">
          <Directory Id="VSCodeInstallDir" Name="Microsoft VS Code">
            <Directory Id="VSCodeBinDir" Name="bin" />
          </Directory>
        </Directory>

        <Directory Id="CodeUserDir" Name="Code">
          <Directory Id="CodeConfigDir" Name="User" />
        </Directory>
      </Directory>

      <Directory Id="TempFolder">
        <Directory Id="VSIXFolder" Name="VSIX" />
      </Directory>
    </Directory>

    <!-- Components -->

    <!-- Dummy parent Programs folder to satisfy ICE64 -->
    <DirectoryRef Id="LocalAppDataPrograms">
      <Component Id="LocalAppDataProgramsComponent" Guid="B5A1F414-1234-4C3D-ABCD-9876543210AB">
        <RegistryValue Root="HKCU" Key="Software\MyCompany\VSCodeCustom" Name="LocalAppDataProgramsKey" Type="string" Value="1" KeyPath="yes"/>
        <RemoveFolder Id="RemoveLocalAppDataPrograms" Directory="LocalAppDataPrograms" On="uninstall"/>
      </Component>
    </DirectoryRef>

    <!-- VS Code installer (embedded, per-user) -->
    <DirectoryRef Id="VSCodeInstallDir">
      <Component Id="VSCodeInstallerComponent" Guid="D53785A0-FD10-4C7B-81B6-6C19D1D5361B">
        <RegistryValue Root="HKCU" Key="Software\MyCompany\VSCodeCustom" Name="InstallerKey" Type="string" Value="1" KeyPath="yes" />
        <File Id="VSCodeSetupExe" Source="Files\vscode-installer.exe" KeyPath="no" />
        <RemoveFolder Id="RemoveVSCodeBin" Directory="VSCodeBinDir" On="uninstall"/>
        <RemoveFolder Id="RemoveVSCodeInstallDir" Directory="VSCodeInstallDir" On="uninstall"/>
      </Component>
    </DirectoryRef>

    <!-- VSIX file -->
    <DirectoryRef Id="VSIXFolder">
      <Component Id="VSIXComponent" Guid="9C2B2AA2-2A4B-4FA2-B59B-9D1A8A3D1234">
        <File Id="MyExtensionVsix" Source="Files\vscode-extension-for-zowe.vsix" KeyPath="yes" />
      </Component>
    </DirectoryRef>

    <!-- User settings -->
    <DirectoryRef Id="CodeConfigDir">
      <Component Id="CodeConfigComponent" Guid="F485E380-3A0D-4B92-8DD6-E5E24205FF5D">
        <RegistryValue Root="HKCU" Key="Software\MyCompany\VSCodeCustom" Name="CodeConfigDirKey" Type="string" Value="1" KeyPath="yes" />
        <File Id="SettingsJson" Source="Files\settings.json" />
        <File Id="KeybindingsJson" Source="Files\keybindings.json" />
        <RemoveFolder Id="RemoveCodeConfigDir" Directory="CodeConfigDir" On="uninstall" />
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="CodeUserDir">
      <Component Id="CodeUserComponent" Guid="B4C06D83-F7F3-4D5C-A754-D8B054C86D13">
        <RegistryValue Root="HKCU" Key="Software\MyCompany\VSCodeCustom" Name="CodeUserDirKey" Type="string" Value="1" KeyPath="yes" />
        <RemoveFolder Id="RemoveCodeUserDir" Directory="CodeUserDir" On="uninstall" />
      </Component>
    </DirectoryRef>

    <!-- CustomActions -->

    <!-- Run embedded VS Code installer -->
    <CustomAction Id="RunVSCodeInstaller"
                  FileKey="VSCodeSetupExe"
                  ExeCommand="/VERYSILENT /NORESTART /MERGETASKS=!runcode /LOG=&quot;[TempFolder]vscode_installer.log&quot;"
                  Execute="deferred"
                  Impersonate="no"
                  Return="check" />

    <!-- Install VSIX via code.cmd -->
    <CustomAction Id="InstallVSIX"
                  Directory="VSCodeBinDir"
                  ExeCommand='"[LocalAppDataPrograms]Microsoft VS Code\bin\code.cmd" --install-extension "[#MyExtensionVsix]" --force'
                  Execute="deferred"
                  Impersonate="yes"
                  Return="check" />

    <!-- Sequence -->
    <InstallExecuteSequence>
      <Custom Action="RunVSCodeInstaller" After="InstallFiles">NOT Installed</Custom>
      <Custom Action="InstallVSIX" After="RunVSCodeInstaller">NOT Installed</Custom>
    </InstallExecuteSequence>

    <!-- Feature tree -->
    <Feature Id="MainFeature" Title="VSCode Custom Installer" Level="1">
      <ComponentRef Id="LocalAppDataProgramsComponent" />
      <ComponentRef Id="VSCodeInstallerComponent" />
      <ComponentRef Id="VSIXComponent" />
      <ComponentRef Id="CodeConfigComponent" />
      <ComponentRef Id="CodeUserComponent" />
    </Feature>

  </Product>
</Wix>
