<?xml version="1.0" encoding="UTF-8"?>
<?define Name = "Powershell Script Runner Installer" ?>
<?define ApplicationVersion = "0.2.0" ?>
<?define Manufacturer = "Manufacturer" ?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <Product Id="*" Name="WixWithCustomAction" Language="1033" Version="$(var.ApplicationVersion)" Manufacturer="$(var.Manufacturer)" UpgradeCode="60468a7d-6485-4e7e-bf82-503213bc43a8">
    <Package InstallerVersion="200" Compressed="yes" InstallScope="perUser" InstallPrivileges="limited" Id="*"/>
    <Media Id="1" Cabinet="Product.cab" EmbedCab="yes"/>



    <Property Id="POWERSHELLEXE">
      <RegistrySearch Id="POWERSHELLEXE" Type="raw" Root="HKLM" Key="SOFTWARE\Microsoft\PowerShell\1\ShellIds\Microsoft.PowerShell" Name="Path"/>
    </Property>
    <Condition Message="This application requires Windows PowerShell."><![CDATA[Installed OR POWERSHELLEXE]]></Condition>
    <!-- permachine-->
    <Feature Id="MainProgram" Title="Engine" Description="Main Feature" Level="1" TypicalDefault="install">
      <ComponentRef Id="launcherScript"/>
      <ComponentRef Id="dependencyScript"/> 
    </Feature>
    <SetProperty Id="WixQuietExecCmdLine" Before="InvokeTestPS1" Sequence="execute" Value="echo &quot;[POWERSHELLEXE]&quot; -noprofile -noninteractive -file &quot;[#TestPS1File]&quot; &quot;testlog&quot; &quot;message text&quot;"/>
    <CustomAction Id="InvokeTestPS1" BinaryKey="WixCA" DllEntry="WixQuietExec" Execute="immediate" Return="check" Impersonate="no"/>
    <InstallExecuteSequence>
     <Custom Action="InvokeTestPS1" Before="InstallFinalize"><![CDATA[NOT Installed]]></Custom> 
    </InstallExecuteSequence>
  </Product>
  <Fragment>
    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFilesFolder">
        <Directory Id="APPLICATIONFOLDER" Name="Powershell Script Runner" />
      </Directory>
    </Directory>
  </Fragment>
  <Fragment>
    <ComponentGroup Id="ProductComponents" Directory="APPLICATIONFOLDER">
      <Component Id="launcherScript" Guid="33b93b79-a971-406f-ac6d-fe5fa2f602cd">
        <File Id="TestPS1File" Name="launcher.ps1" DiskId="1" Source="launcher.ps1"/>
        <RegistryKey Root="HKCU" Key="Software\$(var.Manufacturer)\$(var.Name)">
          <RegistryValue Name="InvokeTestPS1" Value="1" KeyPath="yes" Type="integer"/>
        </RegistryKey>
        <RemoveFolder Id="INSTALLFOLDER" On="uninstall"/>
        <RemoveFile Id="TestPS1File" Name="launcher.ps1" On="uninstall"/>
      </Component>
      <Component Id="dependencyScript">
        <File Id="DependencyPS1File" Name="dependency.ps1" Source="dependency.ps1" Vital="yes" KeyPath="yes" DiskId="1" />
      </Component>
<!--
      <Component Id="dependencyScript" Guid="9e32846a-297e-49f3-b1a8-eb08034dd83f">
        <File Id="DependencyPS1File" Name="dependency.ps1" DiskId="1" Source="dependency.ps1"/>
        <RegistryKey Root="HKCU" Key="Software\$(var.Manufacturer)\$(var.Name)">
          <RegistryValue Name="DependencyPS1File" Value="1" KeyPath="yes" Type="integer"/>
        </RegistryKey>
        <RemoveFile Id="DependencyPS1File" Name="dependency.ps1" On="uninstall"/>
      </Component>
-->
    </ComponentGroup>
  </Fragment>
</Wix>
